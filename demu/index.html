<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Basic page needs. -->
    <meta charset="UTF-8">
    <meta name="description" content="A WebAssembly powered DCPU-16 emulator.">
    <meta name="author" content="Andrew Kersten">
    <title>DCPU-16 Emulator</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <link rel="stylesheet" href="css/custom.css">

    <!-- Favicon -->
	<link rel="icon" type="image/png" href="images/favicon.png">

	<!-- Google Analytics -->
	<!--
	<script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-85712146-1', 'auto');
        ga('send', 'pageview');
    </script>
    -->

    <!-- WebGL Shaders -->
    <script id="shader_fullquad_v" type="x-shader/x-vertex">
    	attribute vec4 vertex;
    	varying highp vec2 texcoord;
    	void main() {
    		texcoord = vertex.zw;
    		gl_Position = vec4(vertex.xy, 0.0, 1.0);
    	}
    </script>

    <script id="shader_fullquad_f" type="x-shader/x-fragment">
    	uniform sampler2D texture0;
    	varying highp vec2 texcoord;

    	void main() {
    		gl_FragColor = texture2D(texture0, vec2(texcoord.x, texcoord.y));
    	}
    </script>
    
    <style type="text/css">
    	body {
    		font-size: 4rem;
    	}

    	@media (min-width: 550px) {
    		body {
    			font-size: 1.5rem;
    		}
    	}

    	canvas {
    		background-color: black;
    	}
    	.emulator {
    		text-align: center;
    	}
    	.sample {
    		background-color: #F1F1F1;
    		border: 1px solid #BBB;
    		border-radius: 4px;
    		padding: 1rem;
    	}
    	.heading {
    		font-weight: 600;
    	}
    	.registerUpdated {
    		color: red;
    	}
    	.registerUnchanged {
    		color: black;
    	}
    	.error {
    		display: none;
    		color: red;
    	}
    	#sourceView {
    		max-height: 64rem;
    		overflow: scroll;
    	}
    </style>
</head>
<body>
	<div class="container">
		<section class="header">
			<h2 class="title">DCPU-16 Emulator</h2>
			<label>What is a DCPU-16?</label>
			<p>
				The DCPU-16 is a fictional 16 bit CPU designed by Markus (Notch) Persson for the game 0x10<sup>c</sup>.  This emulator was built based on the version 1.7 <a href="specs/dcpu-1-7.txt">specification document</a> which has 12 registers, 36 operations, 65536 words of RAM, and a clock speed of 100KHz.  Several peripheral device specifications were released as well, including the <a href="specs/lem1802.txt">LEM1802 monitor</a> and <a href="specs/clock.txt">Generic Clock</a>.
			</p>
			<label>A little bit about the emulator:</label>
			<p>
				This emulator is powered by my own C library, <a href="https://github.com/andrewkersten/LibDCPU16">LibDCPU16</a>, which has been compiled into a WebAssembly module to run in the browser.  LibDCPU16 implements all 36 operations of the 1.7 specification and is cycle accurate.  LibDCPU16 has built in support for the LEM1802 display and Generic Clock, as well as exposing an API for attaching custom devices.  This emulator attaches both devices to the DCPU and renders the LEM1802 display to a WebGL canvas.  Try out some of the samples from down below!
			</p>
		</section>
		<div class="row emulator">
			<label id="error" class="error"></label>
			<div class="canvasContainer">
				<canvas id="canvas" width="384" height="288">A WebGL capable browser is required to view the display.</canvas>
			</div>
			<p>
				<input type="button" id="startStopButton" value="Start" onclick="emulator.handleStartStop()">
				<input type="button" value="Cycle" onclick="emulator.handleStep()">
				<input type="button" value="Reset" onclick="emulator.handleReset()">
			</p>
			<p>
				<label id="speedLabel">Emulation Speed: 0Hz</label>
				<input id="speedSlider" type="range" min="1" max="100" value="10" oninput="emulator.handleSpeedChange(this.value)">
			</p>
			<label style="margin-top: -3rem;">Registers:</label>
			<p>
				<code id="RA" class="registerUnchanged">RA: 0x0000</code>
				<code id="RB" class="registerUnchanged">RB: 0x0000</code>
				<code id="RC" class="registerUnchanged">RC: 0x0000</code>
				<code id="RX" class="registerUnchanged">RX: 0x0000</code>
				<code id="RY" class="registerUnchanged">RY: 0x0000</code>
				<code id="RZ" class="registerUnchanged">RZ: 0x0000</code>
			</p>
			<p>
				<code id="RI" class="registerUnchanged">RI: 0x0000</code>
				<code id="RJ" class="registerUnchanged">RJ: 0x0000</code>
				<code id="PC" class="registerUnchanged">PC: 0x0000</code>
				<code id="SP" class="registerUnchanged">SP: 0x0000</code>
				<code id="EX" class="registerUnchanged">EX: 0x0000</code>
				<code id="IA" class="registerUnchanged">IA: 0x0000</code>
			</p>
			<label id="queueLabel">Interrupt Queue: 0 / 256</label>
		</div>
		<h5 class="heading">Select a Sample:</h5>
		<div class="row">
			<div class="four columns sample">
				<label>Stripes, Stripes, Stripes</label>
				<p>Fill the display with colored vertical stripes.</p>
				<button type="button" onclick="sampleSelected('stripes')" style="width: 100%;">Run</button>
			</div>
			<div class="four columns sample">
				<label>Animated Luigi</label>
				<p>Displays an animated Luigi sprite.  High emulation speed recomended.</p>
				<button type="button" onclick="sampleSelected('luigi')" style="width: 100%;">Run</button>
			</div>
			<div class="four columns sample">
				<label>Hello, World!</label>
				<p>Prints "Hello, World!" to the display.</p>
				<button type="button" onclick="sampleSelected('hello')" style="width: 100%;">Run</button>
			</div>
		</div>
		<h5 class="heading" style="margin-top: 2rem;">Source of selected sample:</h5>
		<pre><code id="sourceView"></code></pre>
	</div>

	<!-- Application Logic -->
	<script type="text/javascript" src="wasm.js"></script>
	<script type="text/javascript">
		if (window.WebAssembly) {
			wasm.createInstance("demu.wasm").then(function() {
				emulator.initialize();
			});
		}
		else {
			var errorLabel = document.getElementById("error");
			errorLabel.textContent = "Your browser doesn't support WebAssembly.";
			errorLabel.style.display = "block";
		}

		function sampleSelected(name) {
			emulator.runSample("samples/" + name + ".bin");

			fetch("samples/" + name + ".asm").then(function(response) {
				response.text().then(function(text) {
					document.getElementById("sourceView").textContent = text;
				});
			});
		}
	</script>
</body>
</html>
